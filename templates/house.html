<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis for {{ house_name }}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        :root {
            --primary-color: #3b82f6; --secondary-color: #8b5cf6; --background-start: #111827;
            --background-end: #1e293b; --text-color: #e5e7eb; --card-bg: rgba(30, 41, 59, 0.5);
            --border-color: rgba(55, 65, 81, 0.6); --input-bg: #374151; --error-bg: rgba(239, 68, 68, 0.2);
            --error-text: #fca5a5;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: linear-gradient(135deg, var(--background-start), var(--background-end)); color: var(--text-color); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        header { padding: 1.5rem 0; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; }
        nav { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 1.8rem; font-weight: 700; color: white; }
        .header-title span { font-weight: 400; color: #9ca3af; }
        .back-btn { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 600; padding: 0.6rem 1.2rem; background: transparent; color: #9ca3af; text-decoration: none; border-radius: 50px; border: 1px solid var(--border-color); cursor: pointer; transition: 0.3s; }
        .back-btn:hover { background-color: var(--border-color); color: white; }
        .animated-section { animation: fadeIn 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .section-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 2.5rem; margin-bottom: 2rem; backdrop-filter: blur(5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .section-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .section-header-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background-image: linear-gradient(to right, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .section-title { font-size: 1.8rem; font-weight: 600; margin: 0; }
        .section-subtitle { margin: -1.2rem 0 2rem 66px; color: #9ca3af; }
        .gallery-container { display: flex; overflow-x: auto; padding: 1rem 0; gap: 1.5rem; scrollbar-width: none; }
        .gallery-container::-webkit-scrollbar { display: none; }
        .image-card { flex: 0 0 320px; height: 240px; border-radius: 15px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s ease; cursor: pointer; }
        .image-card:hover { transform: scale(1.03); box-shadow: 0 0 25px rgba(59, 130, 246, 0.3); }
        .image-card img { width: 100%; height: 100%; object-fit: cover; }
        .upload-form { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .file-input-wrapper { position: relative; width: 100%; max-width: 500px; }
        .file-input-label { background-color: var(--input-bg); border: 2px dashed var(--border-color); border-radius: 15px; padding: 2rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; text-align: center; }
        .file-input-label:hover { border-color: var(--primary-color); background-color: #2b3546; }
        #file-upload-filename { color: #9ca3af; margin-top: 1rem; font-weight: 500; }
        input[type="file"] { display: none; }
        .upload-btn { font-size: 1.1rem; font-weight: 600; padding: 0.8rem 2.5rem; background-image: linear-gradient(to right, var(--primary-color) 0%, var(--secondary-color) 51%, var(--primary-color) 100%); background-size: 200% auto; color: white; border-radius: 50px; border: none; cursor: pointer; transition: 0.5s; }
        .upload-btn:hover { background-position: right center; box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); }
        .flash-message { padding: 1rem 1.5rem; border-radius: 10px; margin: 0 auto 1.5rem auto; max-width: 500px; font-weight: 500; animation: slideDown 0.5s ease-out; background: var(--error-bg); color: var(--error-text); border: 1px solid var(--error-text); text-align: center; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOADER STYLES --- */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #loader-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .loader-spinner {
            border: 5px solid #374151;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-status {
            color: var(--text-color);
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 2rem;
            min-height: 2em;
        }
        .loader-box {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 4rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="loader-box">
            <div class="loader-spinner"></div>
            <p id="loader-status" class="loader-status">Initializing...</p>
        </div>
    </div>

    <header>
        <nav class="container">
            <h1 class="header-title">{{ house_name }} <span>/ Analysis</span></h1>
            <a href="{{ url_for('index') }}" class="back-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Back to Dashboard
            </a>
        </nav>
    </header>

    <main class="container">
        <section class="section-card animated-section" style="animation-delay: 0.2s;">
            <div class="section-header">
                <div class="section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                <h2 class="section-title">Baseline Image Gallery</h2>
            </div>
            <p class="section-subtitle">The AI will compare against these pre-processed baseline images.</p>
            <div class="gallery-container">
                {% for path in image_paths %}
                <div class="image-card"><img src="{{ url_for('static', filename=path) }}" alt="Baseline Environment Thumbnail"></div>
                {% endfor %}
            </div>
        </section>

        <section class="section-card animated-section" style="animation-delay: 0.4s;">
            <div class="section-header">
                <div class="section-header-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path><path d="M12 10h-2v2"></path><path d="M12 6h-2v2"></path><path d="M12 14h-2v2"></path><path d="M16 10h-2v2"></path><path d="M16 6h-2v2"></path><path d="M16 14h-2v2"></path><path d="M8 10H6v2"></path><path d="M8 6H6v2"></path><path d="M8 14H6v2"></path></svg></div>
                <h2 class="section-title">Perform New Analysis</h2>
            </div>
            <p class="section-subtitle">Upload the current image of the environment to detect changes.</p>
            
            <form id="analysis-form" method="post" enctype="multipart/form-data" class="upload-form" onsubmit="return showLoader()">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}{% for message in messages %}<div class="flash-message">{{ message }}</div>{% endfor %}{% endif %}
                {% endwith %}
                <div class="file-input-wrapper">
                    <label for="file-upload" class="file-input-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-2.4-4.2-4.8-4.8-.7-.2-1.5-.3-2.2-.1-1.4.4-2.6 1.3-3.5 2.5-.4.5-.7 1-1 1.5C9.2 10.3 8.1 9 6.8 8.4c-1.3-.6-2.7-.6-4 .2-1.8 1.1-2.9 2.9-3 5-.1 1.7.6 3.4 1.8 4.5C2.8 19.4 4.1 20 5.5 20H6c.9 0 1.8-.3 2.5-.9 1.4-1.1 2.2-2.8 2.5-4.5.3-1.8-.4-3.5-1.5-4.8-.5-.6-1.1-1.1-1.8-1.4"></path><path d="M12.5 12.5c0 2.2-1.3 4-3 5 .5-1.7.5-3.4 0-5.1 1.7-1 3-2.8 3-5Z"></path><path d="M18.5 12.5c0 2.2-1.3 4-3 5 .5-1.7.5-3.4 0-5.1 1.7-1 3-2.8 3-5Z"></path></svg>
                        <span id="file-upload-filename">Click to upload or drag & drop</span>
                    </label>
                    <input type="file" name="file" id="file-upload" accept="image/*" onchange="updateFilename(this)" required>
                </div>
                <button type="submit" class="upload-btn">Analyze Image</button>
            </form>
        </section>
    </main>

    <script>
        function updateFilename(input) {
            const filenameSpan = document.getElementById('file-upload-filename');
            if (input.files && input.files.length > 0) {
                filenameSpan.textContent = `File selected: ${input.files[0].name}`;
            } else {
                filenameSpan.textContent = 'Click to upload or drag & drop';
            }
        }

        function showLoader() {
            const overlay = document.getElementById('loader-overlay');
            const statusText = document.getElementById('loader-status');
            const fileInput = document.getElementById('file-upload');

            if (fileInput.files.length === 0) {
                // Let the browser handle the 'required' validation
                return true; 
            }

            overlay.classList.add('visible');

            const statuses = [
                "Initializing analysis...", "Uploading current state...", "Finding best viewpoint match...",
                "Aligning image perspectives...", "Running AI object recognition...", "Scanning for anomalies...",
                "Generating final report..."
            ];
            
            let statusIndex = 0;
            statusText.textContent = statuses[statusIndex];

            const interval = setInterval(() => {
                statusIndex++;
                if (statusIndex < statuses.length) {
                    statusText.textContent = statuses[statusIndex];
                } else {
                    clearInterval(interval);
                }
            }, 2500);
            
            // Allow the form to submit
            return true;
        }
    </script>
</body>
</html>